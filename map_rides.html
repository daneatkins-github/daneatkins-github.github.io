

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <title>Maps Application</title>

    <!-- dependencies -->
	<link rel="stylesheet" type="text/css" href="https://js.arcgis.com/calcite-components/2.13.2/calcite.css" />
	<link rel="stylesheet" href="https://js.arcgis.com/4.31/esri/themes/light/main.css" />
    <script src="https://js.arcgis.com/4.31/"></script>
    
	<!-- custom styles / page layout -->
	<style>
      html,
      body {}

/* Primary Layouts */	  
	.page_div {
		position:relative;
		margin-left:auto;
		margin-right:auto;
		width:99%; height:98%;
	  }
      
	  .mapDiv {
    	position:absolute; top:0; left:0;
    	float:left;
    	padding: 0;
    	margin:  0;
    	height: 100%;
    	width: 69%;
		border: 2px solid black;
      }

  
	  .basemap_bar {
		position: absolute; top:10px; left:100%;
		margin-left: -120px;
		width:100px;
		
		border: 2px solid black;
		background: white;
		padding: 3px;
		z-index: 1;
		
		font-size:15px !important; 
	  }
	  	  	  
/* Custom Console */
	  .console_div {
	    position:absolute; 
		top:0; right:0;
		width:30%; height:100%;
	  
		border: 2px solid black;
		background:white;
		display:inline-block;
		visibility:visible;
		z-index:3;
	  }
	  .console_log {
		padding:3px;
		overflow:auto;
	  }
	  
	  form {
		display:inline;
		margin:0;
		padding:0;
	  }

	  hr { width:100%; height:1px; background: #fff; 
		 margin:0px; padding:0px;}

/* Custom 'Table & Button Widget' */	  
	  .tableDiv {
		height: 51.25%; 
		width:69%; 
		margin-left:auto;
		margin-right:auto;
				
		position:absolute;
		top:48.75%; 

		border: 2px solid gray;
		background-color:Linen;
		visibility:hidden;
		z-index: 2;
	  }
	  
	  .tableControl {
	    height:8%;
		min-height:22px;
		width:100%;
		display: inline-block;
		text-align:right;
		position:relative;
	  }
	  
	  .tableControl_left {
		position:absolute;
		height:100%;
		left:0;
		z-index:2;
	  }
	  .tbl_tab {
		height:100%;
		width:140px;
		float: left;
		border:1px solid black; border-radius: 5px;
		outline: none;
		cursor: pointer;
		font-size: 18px;
		text-align:center;
	  }


	  
	  .tableControl_content {
		position:absolute;
		right:0;
		top:50%;
		margin-top:-.9em;
		z-index:2;
		min-height:23px;
	  }
	  .tableContainer {
	    position:relative;
		height:92%;
		width:100%;
	  }
	  .tbl_btn {
		margin-top:4px;
	  }
	  
	  .popup_img {
	    border: 2px solid blue;
	  }
	  .popup_img_hidden {
		visibility:hidden;
	  }
	  
	  
	  
/* Custom 'Layer Widget' */	  
	  .layer_bar {
		visibility:hidden;
		position: absolute; left:1px; bottom:1px;
		
		width:200px;
		height:auto;
		
		border: 2px solid black;
		background: white;
		padding: 3px;
		
		font-size:14px !important;
	  }
	  .layer_desc {
	    display:inline-block;
		width:90px;
		position:relative;
		top: -1px;
	  }
	  .layer_chk {
		margin-top:6px;
	  }  
	  .lyr_slide {
		width:50px;
		
		position:relative;   
		top:3px;
	  }	  
	  
/* Popup Zindex */
.esri-popup {
  position: relative;
  z-index: 9 !important;
}

.esri-popup__main-container {
  z-index: 99 !important;
}
 
	  
    </style>

	
<!-- custom scripting -->
<script>


	
	
	// Builds from Array:
	layers_names  = ['2016', '2017',  '2018',   '2019', '2020', '2021', '2022', '2023', '2024']
	layers_colors = ['#1b9e77','#d95f02','#7570b3','#e7298a','#66a61e','#e6ab02','#a6761d','#666666', 'blue']
	layers = {}
	
	//wait for document:
	window.addEventListener('DOMContentLoaded', function() {
		// handle user selection: map or table?
			set_by = null;
			const tableDiv = document.getElementById("tableDiv");
			const mapDiv   = document.getElementById("mapDiv");
			
			tableDiv.addEventListener('click', function(event) {
				set_by = "table";
			});
			mapDiv.addEventListener('click', function(event) {
				set_by = "map";
			});

		//load required modules from ESRI
		require(["esri/layers/GeoJSONLayer", "esri/symbols/SimpleLineSymbol", "esri/PopupTemplate"], 
			(GeoJSONLayer, SimpleLineSymbol, PopupTemplate) => {
		
			// define popup (once for all layers/same schema):
			const cust_popup = new PopupTemplate({
				outFields:["*"],
				title: "",
				content: "<span style='font-weight:bold;'>{Act_Name}</span><br>Date: {Date_Day}/{Date_Mon}/{Date_Yr}<br>Distance: {Dist_Mi} miles;"+
						 " +{ElevGain} feet<br>Speed: {SpeedAvg} mph;  Max: {SpeedMax} mph"  // Body-content of popup;
			});
		
			// loop through layers_names; build each layer as object.
			layers_names.forEach( (lyr_name, index) => {
				
				//custom symbology
				var  lyr_sym = {
					"type": "simple", 
					"symbol":{    
						type: "simple-line", 
						style: "solid",
						color: layers_colors[index],    
						width: "3px"		
						     }
				}; // end lyr_sym
								   
				//create layer object, store in 'layers' object
				var lyr_url   = `https://daneatkins-github.github.io/assets/fc/${lyr_name}.geojson`
				var lyr_title = `${lyr_name} Rides` 
				
				layers[lyr_name] = new GeoJSONLayer({
					url: lyr_url,
					id: lyr_name,
					spatialReference: {wkid: 102100},
					renderer: lyr_sym,
					title: lyr_title,
					selectionMode: "single",
					outFields: ["*"],
					popupTemplate: cust_popup
				});				
			}); // end 'loop through layers_arr'
			
			// one off layers (attributes for table, here):
			ride_attr = new GeoJSONLayer({
				url: "https://daneatkins-github.github.io/assets/fc/ride_attr.geojson",
				spatialReference: {wkid: 102100},
				renderer:null,
				title: "Ride Attr",
				selectionMode: "single",
				outFields: ["*"],
				popupTemplate: cust_popup
			});
			
			log_msg("<br>Built layers.");
			// call the next step:
			load_map_object();

		}); // end require 'load modules'
	}); // end onload event 
	
	
	// call this function after layers are built.
	function load_map_object(){

		// load required modules:
        require(["esri/Map", "esri/views/MapView"], 
	      (Map, MapView) => {
			
			// map
			map = new Map({    
				basemap: "topo"
			}); // end map
		
			// map view (and css connection)
			mapView = new MapView({
				container: "mapDiv", // Reference to the container in html/css
				map: map,            // Reference to the map object created before the view
				zoom: 3,             // Sets zoom level based on level of detail (LOD)
				center: [-108.854709, 44.673518],     // Sets center point of view using longitude,latitude
				popup: {
					dockOptions: {buttonEnabled:false}
				}
			}); // end mapView

			// shoehorn some popup customization here.
			mapView.popup.visibleElements = { actionBar:false,
											  collapseButton:false,
											  closeButton:true,
											  heading:false};
			mapView.popup.highlightEnabled = false;  // we'll handle highlights 'by selection'
			
			// add the layers
			for (let key in layers){
				//log_msg('<br>');log_msg(key);log_msg(': '); log_msg(layers[key].title); 
				map.add(layers[key]);
			}
				//oneoff:
				map.add(ride_attr);
		
			// add bloom effect
			require(["esri/layers/support/FeatureEffect", "esri/views/layers/LayerView"],
			  (FeatureEffect, LayerView) => {
				for (let key in layers){
					// when LayerView is ready
					mapView.whenLayerView(layers[key]).then((layerView) => {
					   	layers[key].effect = "bloom(2, 0.3px, 0.1%)"; 		 
					});
				}
			}); // end bloom effect 
		}); // end loading map modules
		
		
		// populate layer widget:
		load_layer_widget();
		
		// call the table:
		load_table_object();

		// populate table 'selector'
		load_table_selector();
		
	} // end load_map_object as function
	
	function load_layer_widget(){
		// built from layer_names array; presumes map load succeeds!
		const layer_bar = document.getElementById('layer_bar');
		layers_names.forEach( (lyr_name, index) => {
			layer_bar.innerHTML += '<input type="checkbox" class="layer_chk" id="' + 
									lyr_name + 
									'" checked /> <span class="layer_desc" style="font-weight:bold;color:' + 
									layers_colors[index] + '">' + lyr_name + 
									' Rides</span> &nbsp;<input id="' + lyr_name + 
									'" type="range" min="0" max="100" value="100" class="lyr_slide"><br>';
		}); // end lyr_name loop

		// add events to layer_bar (visibility and opacity)
		layer_bar.addEventListener('click', function(event) {
			// if event is checkbox (visibility toggle):
			if (event.target.classList.contains('layer_chk')){
				// toggle the target layer
				layers[event.target.id].visible = event.target.checked;
			}
		
			// if event is slider (visibility toggle):
			if (event.target.classList.contains('lyr_slide')){
				// change the opacity to match slider
				layers[event.target.id].opacity = (event.target.value/100)
			}
		}); // end layer_bar listener	
	} // end load_layer_widget


	function load_table_object(){
		log_msg("<br>Tbl Seq... ");
	
		// load ESRI table modules 
		require(["esri/widgets/FeatureTable", "esri/core/reactiveUtils"], (FeatureTable, reactiveUtils) => {
	
			// wait for mapview to finish loading completely -- prevents empty tableview	
			const runonce_handle = reactiveUtils.when( () => mapView.updating == false,	() => {
		
				log_msg("<br>mapView load: ");

				// create table 'object'
				table = new FeatureTable({
					id: "MyTable",
					view: mapView,   // tie to map for selection/highlighting
					highlightEnabled:true,
					layer: ride_attr,
					container: "tableContainer", 	// attach to a DOM element.
					visibleElements: { menu: false },
						tableTemplate: {
							columnTemplates: [
							{type:"field",
							 fieldName:"__OBJECTID",
							 label:"OID",
							 visible: true,
							 width:65
							 },
							{type:"field",
							 fieldName:"KEY",
							 label:"KEY",
							 visible: true,
							 width:65
							 },
							{type:"field",
							 fieldName:"Date_Str",
							 label:"Date-Time (Z)",
							 visible: true,
							 width:100
							 },
						/*  calculated column fails sort (maybe values don't exist)?
							 {type:"column",
							 fieldName:"Dist_Mi_str",
							 label:"Mi",
							 formatFunction: ({feature}) => {return feature.attributes["Dist_Mi"].toFixed(1)},
							 sortable: true,  
							 visible: true,
							 textAlign:"end",
							 width:65
							 },   */
							{type:"field",
							 fieldName:"Dist_Mi",
							 label:"Miles",
							 visible: true,
							 textAlign:"end",
							 width:65
							 },
							{type:"field",
							 fieldName:"MovTimeS",
							 label:"Moving Time",
							 visible: true,
							 width:75
							 },
							{type:"field",
							 fieldName:"Act_Name",
							 label:"Name",
							 visible: true,
							 width:75
							 },
							{type:"field",
							 fieldName:"Act_Desc",
							 label:"Description",
							 visible: true,
							 width:150
							 },
							{type:"field",
							 fieldName:"Speed_Avg",
							 label:"Speed",
							 visible: true,
							 width:50
							 },
							 {type:"field",
							 fieldName:"Speed_Max",
							 label:"Max Speed",
							 visible: true,
							 width:50
							 },
							 {type:"field",
							 fieldName:"ElevGain",
							 label:"Elevation (ft)",
							 visible: true,
							 width:50
							 },
							 {type:"field",
							 fieldName:"ElevHigh",
							 label:"Altitude (ft)",
							 visible: true,
							 width:50
							 },
							 {type:"field",
							 fieldName:"Bike_Nm",
							 label:"Bike",
							 visible: true,
							 width:50
							 },
							 {type:"field",
							 fieldName:"Temp",
							 label:"Temperature",
							 visible: true,
							 width:50
							 }
						]}  // end tableTemplate
				}); // end table definition
					
				// shoehorn property:
				table.multipleSelectionEnabled = false;
				log_msg('tbl rdy');
						
				
				// table selection handler
				table.highlightIds.on("change", (event) => {
					log_msg('<br> chg in table selc');
				
					if (set_by == "table") {		// selection changed by user; update map too:
						tbl_selected = event.added
						if (tbl_selected != ""){  // check for "deselect";
							log_msg('.. upd map')
							
							log_msg('<br> .. ts '); log_msg(tbl_selected)
							
							// objectIDs aren't 1:1, need to query by an attribute (or two) to get into the map; 
							var ride_attr_query = {
								where: `__OBJECTID = '${tbl_selected}'`,
								outFields: ["__OBJECTID", "KEY", "Date_Yr"],
								returnGeometry:false
							}
						
							// perform the query, 'highlight' the result in the map.
							ride_attr.queryFeatures(ride_attr_query)
								.then((results) => {
									var res_feature = results.features[0];
									tbl_selected = results.features[0].attributes;
									log_msg(`<br> &nbsp;&nbsp;.. fnd: ${tbl_selected.KEY}; ${tbl_selected.Date_Yr}`);

									// we have the feature from the 'table'. now we need the actual feature in mapLayer...
									var layer_query = {
										where: `KEY = '${tbl_selected.KEY}'`,
										outFields: ["__OBJECTID", "KEY", "Date_Yr"],
										returnGeometry:false
									}
									layers[tbl_selected.Date_Yr].queryFeatures(layer_query)
										.then((lyr_result) => {
											log_msg("<br>");
											log_msg(JSON.stringify(lyr_result.features[0].attributes.__OBJECTID));
											log_msg(" .. ");
											log_msg(JSON.stringify(lyr_result.features[0].attributes.KEY));
										
										// set the map Popup
										mapView.popup.open({ features: [lyr_result.features[0] ]});
										// set the highlight:
										
										
									});
									
									/*
									mapView.whenLayerView(layers[tbl_selected.Date_Yr]).then(function(lyrView) {
										log_msg("..lyrView");
										mapView.popup.open({
											features:res_feature
										});
										log_msg('.done.');
									});
									*/
							});
							
				
							

						} // end deselect check
					} else {
						// table update was made by a change was made in the map; do nothing.
						log_msg("..do not");
					} // end if set_by table;

					/*
				// enable/disable zoomTo based on selection.
					if (tbl_selected != ""){
						//log_msg('here');
						zoomTo_btn.removeAttribute("disabled");
						
						
						//map_select_by_feature(tbl_selection);
					
					} else {
						//log_msg('not here');
						zoomTo_btn.setAttribute("disabled", "disabled");
					}
					*/
				}); // end table_selection handler;
				
			runonce_handle.remove();	
			});	// end reactiveUtils 
			


			
			// handle highlights/selection (watch for popup.selectedFeature);
			let cur_highlight;
			let cur_selected = {};
			reactiveUtils.watch( () => mapView.popup.selectedFeature, (sel_feat) => {
			log_msg(`<br> user select by: ${set_by}`);
			
				if (sel_feat){
					feature = sel_feat;
				
					// remove any existing highlights;
					if (cur_highlight){cur_highlight.remove()}
				
					// record some details (i.e., need Year/Layer to check table/filters);
					cur_selected = {
									OID : feature.attributes.__OBJECTID, 
									KEY : feature.attributes.KEY, 
									LYR : feature.attributes.Date_Yr
									}
					
					// get layerview to apply a highlight:
					mapView.whenLayerView(layers[cur_selected.LYR]).then(function(lyrView) {
						// assign the highlight to a 'handle' so we can remove it later;
						cur_highlight = lyrView.highlight(cur_selected.OID)
						
					}); // end layerview ops
					log_msg(`<br>ms${cur_selected.KEY}, ${cur_selected.LYR}`)
					
					// if the user set_by the map: also update the table:
					if (set_by == "map"){	
						log_msg("<br> ..... updating table select");
						tbl_select_by_feature(cur_selected);   
					};
					
				} else {
					// remove any existing highlights;
					if (cur_highlight){cur_highlight.remove()}
					cur_highlight = null;
					table.highlightIds.removeAll();
					log_msg("<br> pop no feat.");
				}
			});			
		}); // end loading required modules
	
	log_msg('loaded.');
	} // end load_table_object function;


	// dropdown selector for table filtering
	function load_table_selector(){
		// populate dropdown from layer_names array; presumes map load succeeds!
		select_drop = document.getElementById('tbl_yr');
		
		layers_names.forEach( (lyr_name, index) => {
			select_drop.innerHTML += '<option value="' + lyr_name + '">'+ lyr_name +'</option>'

		}); // end populate dropdown

		// add events to dropdown (year filters)
		select_drop.addEventListener('change', function(event) {
			// dropdown changed?  
			log_msg('<br>'); log_msg(select_drop.value);
			
			// filter the table:
			tbl_filter_by_Year(select_drop.value);
			log_msg('called filt');
			
		}); // end dropdown listener
	
	} // end load_table_selector


////////////////////
/// helper functions




	// prints string to 'console' on the HTML page
	function log_msg (msg) {
		document.getElementById("my_console").innerHTML += msg;
	} 


	// simple handler to show/hide the div with table.
	table_toggle = true //initial state;
	function table_handler() {
		if(table_toggle){
			document.getElementById('tableDiv').style.visibility = 'visible'
			document.getElementById('mapDiv').style.height = '48%';
			table_toggle = false;		
		} else {
			document.getElementById('tableDiv').style.visibility = 'hidden';
			document.getElementById('mapDiv').style.height = '100%';
			table_toggle = true;
		}	
	} // end table_toggle handler


	layer_toggle = false;
	// simple handler to show/hide div with Layer controls
		function layer_handler() {
			if(layer_toggle){
				document.getElementById('layer_bar').style.visibility = 'hidden';
				layer_toggle = false;		
			} else {
				document.getElementById('layer_bar').style.visibility = 'visible';
				layer_toggle = true;		
			}	
		}


	//waiting for document, global listeners:
	window.addEventListener('DOMContentLoaded', function() {	 

		// filter table by selection?
		tbl_filter_by = document.getElementById('tbl_select_chk');
		tbl_filter_by.addEventListener('change', () => {
			table.filterBySelectionEnabled = tbl_filter_by.checked
		});	 
	 
	});	// end waiting for document
	 
	 
	 
	// function to filter by year:
	function tbl_filter_by_Year(year){
			if (!layers_names.includes(year)) {
				// no layer selected, reset layer to 'all'
				where_q = "1=1"
				ride_attr.definitionExpression = where_q
			} else {
				// build new definition
				where_q = `Date_Yr = ${year}`
				ride_attr.definitionExpression = where_q;
			}
	} // end year_filter function
	
	// function to query/select by attribute:
	function tbl_select_by_feature(tbl_feature){
		
		// may need to change tbl's year-dropdown selector
		var feat_lyr = tbl_feature.LYR;
		if (feat_lyr != select_drop.value && select_drop.value != 'All'){
			// feature is not shown in table; 
			select_drop.value = feat_lyr
			tbl_filter_by_Year(select_drop.value);
		}
			
		// objectIDs aren't 1:1, need to query by an attribute (or two); 
		var ride_attr_query = {
			where: `KEY = '${tbl_feature.KEY}'`,
			outFields: ["__OBJECTID", "KEY"],
			returnGeometry:false
		}
		
		// perform the query, 'highlight' the result in the table.
		ride_attr.queryFeatures(ride_attr_query)
			.then((results) => {
				table.highlightIds.removeAll()
				table.highlightIds.add(results.features[0].attributes.__OBJECTID)
			});
	}; // end tbl_select_by_feature;
	
	
	
	function zoom_to_tblSelect(){
	// use the table selection to set mapfocus;
		log_msg('<br>zoomin.. '); log_msg(table.highlightIds)
		
		table.zoomToSelection();
		mapView.zoom = 10;
	}
	

	
	function map_select_by_feature(map_feature){
		log_msg("<br> .. change map highlight. "); log_msg(map_feature);
	
	}	
		

	
	

	function do_stuff2(){
		log_msg('do2');
		
	}
	
	function do_stuff(){
		log_msg('dooo');
		log_msg(mapView.popup);
		log_msg(JSON.stringify(mapView.popup.selectedFeature));
	}
	


	
	
</script>
	
  </head>

  <body>
  <!-- viewport container -->
 <div class="page_div" id="page_div">
  
    <!-- map container -->
	<div class="mapDiv" id="mapDiv">
		<div class="layer_bar" id="layer_bar">
			<!-- layer list / controls populated dynamically -->
		</div>
		<div class="basemap_bar" id="basemap_bar">
  		  <form name="basemap_selector">
			<input type="radio" id="base_map" name="base_map" value="topo" checked>Topo <br>
			<input type="radio" id="base_map" name="base_map" value="hybrid">Hybrid <br>
			<input type="radio" id="base_map" name="base_map" value="streets">Streets<br>
			    <hr />
			<button type="button" onclick="layer_handler();" style="width:100px">Layers</button>
		    <button type="button" onclick="table_handler();" style="width:100px">Table</button>	  
		  </form>
		</div>
		
	</div> <!-- end map container -->
	
	<!-- righthand pane -->
  	<div class="console_div" id="console_div">
		<div class="console_log" id="my_console">
		Logging....
		</div>
	</div>

	<!-- table pane -->
	<div id="tableDiv" name="tableDiv" class="tableDiv">
		<div class="tableControl">

			<div class="tableControl_left">				
				<select id="tbl_yr" name="tbl_yr" class="tbl_tab">
					<option value="All" >All Years</option>
				</select>
				<input type="checkbox" class="select_chk" id="tbl_select_chk" /> Filter table by Selection?</span>
			</div>
				
			<div class="tableControl_content">
				<button type="button" onclick="do_stuff2();" class="tbl_btn">Do Stuff2</button>
				<button type="button" onclick="do_stuff();" class="tbl_btn">Do Stuff</button>
				<button type="button" onclick="zoom_to_tblSelect();" class="tbl_btn" id="zoomTo_btn" disabled>Zoom to Selection</button>	  	
			</div>
		</div>
		
		<div id="tableContainer" class="tableContainer">
				
		</div>
	</div>


	
</div> <!-- end pageDiv --> 



  </body>
</html>
