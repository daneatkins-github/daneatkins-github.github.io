

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <title>Maps Application</title>

    <!-- dependencies -->
	<link rel="stylesheet" type="text/css" href="https://js.arcgis.com/calcite-components/2.13.2/calcite.css" />
	<link rel="stylesheet" href="https://js.arcgis.com/4.31/esri/themes/light/main.css" />
    <script src="https://js.arcgis.com/4.31/"></script>
    
	<!-- custom styles / page layout -->
	<style>
      html,
      body {}

/* Primary Layouts */	  
	.page_div {
		position:relative;
		margin-left:auto;
		margin-right:auto;
		width:89%; height:98%;
	  }
      
	  .mapDiv {
    	position:absolute; top:0; left:0;
    	float:left;
    	padding: 0;
    	margin:  0;
    	height: 100%;
    	width: 89%;
		border: 2px solid black;
      }

  
	  .basemap_bar {
		position: absolute; top:10px; left:100%;
		margin-left: -120px;
		width:100px;
		
		border: 2px solid black;
		background: white;
		padding: 3px;
		z-index: 1;
		
		font-size:15px !important; 
	  }
	  	  	  
/* Custom Console */
	  .console_div {
	    position:absolute; 
		top:0; right:0;
		width:10%; height:100%;
	  
		border: 2px solid black;
		background:white;
		display:inline-block;
		visibility:visible;
		z-index:3;
	  }
	  .console_log {
		padding:3px;
		overflow:auto;
	  }
	  
	  form {
		display:inline;
		margin:0;
		padding:0;
	  }

	  hr { width:100%; height:1px; background: #fff; 
		 margin:0px; padding:0px;}

/* Custom 'Table & Button Widget' */	  
	  .tableDiv {
		height: 51.25%; 
		width:89%; 
		margin-left:auto;
		margin-right:auto;
				
		position:absolute;
		top:48.75%; 

		border: 2px solid gray;
		background-color:Linen;
		visibility:hidden;
		z-index: 2;
	  }
	  
	  .tableControl {
	    height:8%;
		min-height:22px;
		width:100%;
		display: inline-block;
		text-align:right;
		position:relative;
	  }
	  
	  .tableControl_left {
		position:absolute;
		height:100%;
		left:0;
		z-index:2;
	  }
	  .tbl_tab {
		height:100%;
		width:140px;
		float: left;
		border:1px solid black; border-radius: 5px;
		outline: none;
		cursor: pointer;
		font-size: 18px;
		text-align:center;
	  }


	  
	  .tableControl_content {
		position:absolute;
		right:0;
		top:50%;
		margin-top:-.9em;
		z-index:2;
		min-height:23px;
	  }
	  .tableContainer {
	    position:relative;
		height:92%;
		width:100%;
	  }
	  .tbl_btn {
		margin-top:4px;
	  }
	  
	  .popup_img {
	    border: 2px solid blue;
	  }
	  .popup_img_hidden {
		visibility:hidden;
	  }
	  
	  
	  
/* Custom 'Layer Widget' */	  
	  .layer_bar {
		visibility:visible;
		position: absolute; top:10px; left:50%;
		margin-left: -100px;
		width:200px;
		height:auto;
		
		border: 2px solid black;
		background: white;
		padding: 3px;
		
		font-size:14px !important;
	  }
	  .layer_desc {
	    display:inline-block;
		width:90px;
		position:relative;
		top: -1px;
	  }
	  .layer_chk {
		margin-top:6px;
	  }  
	  .lyr_slide {
		width:50px;
		
		position:relative;   
		top:3px;
	  }	  
	  
    </style>

	
	<!-- custom scripting -->
    <script>
	/// Global Access:
	// define map / mapView:
	var map;
	var mapView;
	
	// define layers:
	var ride_attr;
	var ride_2020_Layer;
	var ride_2021_Layer;
	var ride_2022_Layer;
	var ride_2023_Layer;	

	///////////////////////////

	  // function that draws a map object:
      require(["esri/Map", "esri/views/MapView", "esri/layers/FeatureLayer", "esri/symbols/SimpleLineSymbol", "esri/PopupTemplate"], 
	    (Map, MapView, FeatureLayer, SimpleLineSymbol, PopupTemplate) => {
	    
		// map object must exist in global; else use "const map = new map(..."
        map = new Map({
          basemap: "topo"
        });

		// map view (and css connection)
        mapView = new MapView({
          container: "mapDiv", // Reference to the container in html/css
          map: map,            // Reference to the map object created before the view
          zoom: 3,             // Sets zoom level based on level of detail (LOD)
          center: [-108.854709, 44.673518],     // Sets center point of view using longitude,latitude
		  popup: {
			dockOptions: {buttonEnabled:false}
				}
        });
		

		//// Layer Definitions and Add:
		  // define renderers
		
		const ride_2020_sym = {"type": "simple", 
							   "symbol":{ type: "simple-line", style: "solid",
				                          color: "#1b9e77",    width: "3px"		}};
		const ride_2021_sym = {"type": "simple", 
							   "symbol":{ type: "simple-line", style: "solid",
				                          color: "#7570b3",    width: "3px"		}};
		const ride_2022_sym = {"type": "simple", 
							   "symbol":{ type: "simple-line", style: "solid",
				                          color: "#d95f02",    width: "3px"		}};
		const ride_2023_sym = {"type": "simple", 
							   "symbol":{ type: "simple-line", style: "solid",
				                          color: "#e7298a",    width: "3px"		}};
		  // define popup:
		  const cust_popup = new PopupTemplate({
			outFields:["*"],
			title: "",
			content: "<span style='font-weight:bold;'>{Act_Name}</span><br>Date: {Date_Day}/{Date_Mon}/{Date_Yr}<br>Distance: {Dist_Mi} miles<br>Speed: {SpeedAvg} mph;  Max: {SpeedMax} mph"  // Body-content of popup;
		  });
		

		// Add Layers:
		require(["esri/layers/GeoJSONLayer"], function(GeoJSONLayer){
		
			ride_attr = new GeoJSONLayer({
				url: "https://daneatkins-github.github.io/assets/fc/Ride_Start_Attr.geojson",
				spatialReference: {wkid: 102100},
				renderer:null,
			  title: "Ride Attr",
			  selectionMode: "single",
			  outFields: ["*"],
			  popupTemplate: cust_popup
			});
		
		
			ride_2020_Layer = new GeoJSONLayer({
				url: "https://daneatkins-github.github.io/assets/fc/2020.geojson",
				spatialReference: {wkid: 102100},
				renderer: ride_2020_sym,
			  title: "2020 Rides",
			  selectionMode: "single",
			  outFields: ["*"],
			  popupTemplate: cust_popup
			});
			
			ride_2021_Layer = new GeoJSONLayer({
				url: "https://daneatkins-github.github.io/assets/fc/2021.geojson",
				spatialReference: {wkid: 102100},
				renderer: ride_2021_sym,
			  title: "2021 Rides",
			  selectionMode: "single",
			  outFields: ["*"],
			  popupTemplate: cust_popup
			});

			ride_2022_Layer = new GeoJSONLayer({
				url: "https://daneatkins-github.github.io/assets/fc/2022.geojson",
				spatialReference: {wkid: 102100},
				renderer: ride_2022_sym,
			  title: "2022 Rides",
			  selectionMode: "single",
			  outFields: ["*"],
			  popupTemplate: cust_popup
			});

			ride_2023_Layer = new GeoJSONLayer({
				url: "https://daneatkins-github.github.io/assets/fc/2023.geojson",
				spatialReference: {wkid: 102100},
				renderer: ride_2023_sym,
			  title: "2023 Rides",
			  selectionMode: "single",
			  outFields: ["*"],
			  popupTemplate: cust_popup
			});
			
			mapView.popup.visibleElements = { actionBar:false,
											  collapseButton:false,
											  closeButton:false,
											  heading:false};
			
			map.add(ride_2020_Layer);  // adds the layer to the map
			map.add(ride_2021_Layer);  // adds the layer to the map
			map.add(ride_2022_Layer);  // adds the layer to the map
			map.add(ride_2023_Layer);  // adds the layer to the map
			map.add(ride_attr);

			// subroutines for FeatureEffect and Extent
			require(["esri/layers/support/FeatureEffect", "esri/views/layers/LayerView", "esri/geometry/Extent", "esri/rest/support/Query"],
				(FeatureEffect, LayerView, Extent, Query) => {
					
					// when LayerView is ready
					mapView.whenLayerView(ride_2020_Layer).then((layerView) => {
					   		ride_2020_Layer.effect = "bloom(2, 0.3px, 0.1%)"; 		 });
					mapView.whenLayerView(ride_2021_Layer).then((layerView) => {
					   		ride_2021_Layer.effect = "bloom(2, 0.3px, 0.1%)";  		});
					mapView.whenLayerView(ride_2022_Layer).then((layerView) => {
					   		ride_2022_Layer.effect = "bloom(2, 0.3px, 0.1%)";  		});		
					mapView.whenLayerView(ride_2023_Layer).then((layerView) => {
					   		ride_2023_Layer.effect = "bloom(2, 0.3px, 0.1%)";  		});
					
			}); 
			
		}); // End add layer

						// filter table by selection?
							const tbl_filter_by = document.getElementById('tbl_select_chk');
							log_msg(tbl_filter_by.checked);
							
							tbl_filter_by.addEventListener('change', () => {
									log_msg('here');
									table.filterBySelectionEnabled = tbl_filter_by.checked
									log_msg(tbl_filter_by.checked);
							});


		
		
		// basemap selector:
		// create a const reference to the radio basemap buttons:
		const basemap_form = document.forms.basemap_selector;
		const basemap_sel  = basemap_form.querySelector('input[name=base_map]:checked');
		
		// for each radio; attach a listener:
		document.querySelectorAll('input[name="base_map"]').forEach((radio) => {
			radio.addEventListener('change', (event) => {
				if (event.target.checked){
					// update basemap:
					map.basemap = event.target.value;
					log_msg(`<br>Base to ${event.target.value}`);
				}
			});
		});
		
		


		// when ready actions:
			// check the width and set popup;
		mapView.when(() => {
			var chk_width = document.getElementById('page_div').offsetWidth;
			width_handler(chk_width);
		});

		// toggle layers:
		  // Create a variable referencing the checkbox node
		const ride_2020_LayerToggle = document.getElementById("rides_2020_lyr_chk");
		const ride_2021_LayerToggle = document.getElementById("rides_2021_lyr_chk");
		const ride_2022_LayerToggle = document.getElementById("rides_2022_lyr_chk");
		const ride_2023_LayerToggle = document.getElementById("rides_2023_lyr_chk");



		  // Listen to the change event for the checkboxs
			ride_2020_LayerToggle.addEventListener("change", () => {
				ride_2020_Layer.visible = ride_2020_LayerToggle.checked; });
			ride_2021_LayerToggle.addEventListener("change", () => {
				ride_2021_Layer.visible = ride_2021_LayerToggle.checked; });
			ride_2022_LayerToggle.addEventListener("change", () => {
				ride_2022_Layer.visible = ride_2022_LayerToggle.checked; });
			ride_2023_LayerToggle.addEventListener("change", () => {
				ride_2023_Layer.visible = ride_2023_LayerToggle.checked; });

			
		// opacity layers:
        const ride_2020_opac = document.getElementById("rides_2020_opac_slide");		
		const ride_2021_opac = document.getElementById("rides_2021_opac_slide");		
		const ride_2022_opac = document.getElementById("rides_2022_opac_slide");		
		const ride_2023_opac = document.getElementById("rides_2023_opac_slide");		
		
			ride_2020_opac.addEventListener('change', function(){
				log_msg("20 opchg<br>");
				ride_2020_Layer.opacity = (ride_2020_opac.value/100);
			});
			ride_2021_opac.addEventListener('change', function(){
				log_msg("21 opchg<br>");
				ride_2021_Layer.opacity = (ride_2021_opac.value/100);
			});
			ride_2022_opac.addEventListener('change', function(){
				log_msg("22 opchg<br>");
				ride_2022_Layer.opacity = (ride_2022_opac.value/100);
			});
			ride_2023_opac.addEventListener('change', function(){
				log_msg("23 opchg<br>");	
				ride_2023_Layer.opacity = (ride_2023_opac.value/100);
			});

	  // end of require functions
      });



/// Legend and Table
// Global References
var legend;
var legend_toggle = true;

var table;
var table_toggle = true;

	function legend_handler() {
		if(legend_toggle){
			require(["esri/widgets/Legend"], (Legend) => {
			legend = new Legend({
				id: "MyLegend",
				view: mapView,
				title: "Map Legend",
				layerInfos: [
					{
						layer: ride_2020_Layer,
						title: "2020 Rides"
					},
					{
						layer: ride_2021_Layer,
						title: "2021 Rides"
					},
					{
						layer: ride_2022_Layer,
						title: "2022 Rides"
					},
					{
						layer: ride_2023_Layer,
						title: "2023 Rides"
					}
				]
			});

			mapView.ui.add(legend, "bottom-left");
			});

			legend_toggle = false;		
		
		} else {
				legend_toggle = true; 
				mapView.ui.remove(legend);
		}	
	}
    const selectElement = document.getElementById('mySelect');



// the table is drawn onLoad, but in a hidden div
require(["esri/widgets/FeatureTable", "esri/core/reactiveUtils", "esri/rest/support/Query"], (FeatureTable, reactiveUtils, Query) => {
	
	// wait for mapview to finish loading completely -- prevents empty tableview	
	reactiveUtils.when( () => mapView.updating == false,	() => {
	
		// check that we haven't drawn the table, yet
		if (typeof table == "undefined"){
			table = new FeatureTable({
				id: "MyTable",
				view: mapView,   // tie to map for selection/highlighting
				//syncSelection:true,
				highlightEnabled:true,
				layer: ride_attr,
				container: "tableContainer", 	
				visibleElements: {
				  menu: false
				},
				tableTemplate: {
					columnTemplates: [
					{type:"field",
					 fieldName:"Act_Name",
					 label:"Name",
					 visible: true,
					 width:100
					 },
					 {type:"field",
					 fieldName:"Date_Str",
					 label:"Date-Time (Z)",
					 visible: true,
					 width:50
					 },
					{type:"field",
					 fieldName:"Act_Desc",
					 label:"Description",
					 visible: true,
					 width:150
					 },
					 {type:"field",
					 fieldName:"Dist_Mi",
					 label:"Miles",
					 visible: true,
					 width:50
					 },
					{type:"field",
					 fieldName:"MovTimeS",
					 label:"Moving Time",
					 visible: true,
					 width:50
					 },
					{type:"field",
					 fieldName:"Speed_Avg",
					 label:"Speed",
					 visible: true,
					 width:50
					 },
					 {type:"field",
					 fieldName:"Speed_Max",
					 label:"Max Speed",
					 visible: true,
					 width:50
					 },
					 {type:"field",
					 fieldName:"ElevGain",
					 label:"Elevation (ft)",
					 visible: true,
					 width:50
					 },
					 {type:"field",
					 fieldName:"ElevHigh",
					 label:"Altitude (ft)",
					 visible: true,
					 width:50
					 },
					 {type:"field",
					 fieldName:"Bike_Nm",
					 label:"Bike",
					 visible: true,
					 width:50
					 },
					 {type:"field",
					 fieldName:"Temp",
					 label:"Temperature",
					 visible: true,
					 width:50
					 }
				]}
				});
			table.multipleSelectionEnabled = false;
		}
	});	




	// trying mapview click filter table
	mapView.on("click", async (event) => {
	  const hitResults = await mapView.hitTest(event);
	  const feature = hitResults.results.find(result => result.graphic && result.graphic.layer === ride_2020_Layer);

	  if (feature) {
		ride_attr.definitionExpression = "1=1";

		const feature_key = feature.graphic.attributes.KEY;
		log_msg(feature_key);
		log_msg('hit layer<br>')
		
			const year_select = document.getElementById('tbl_yr');
			year_select.selectedIndex = 0;
			

			var query = new Query();
				var where_q = `KEY = ${feature_key}`;
				log_msg(where_q);
				
				query.where = `KEY = ${feature_key}`;
				query.outFields = ["__OBJECTID", "Act_Name"];

				ride_attr.queryFeatures(query).then((results) => { 
					log_msg(results.features[0].attributes.__OBJECTID);
					
					table.highlightIds.removeAll()
					table.highlightIds.add(results.features[0].attributes.__OBJECTID)
					log_msg('<br>');
					log_msg(table.highlightIds.length);
				});
	  }
	});

	// trying definition query based on dropdown 'select'
	var year_select = document.getElementById('tbl_yr');

    year_select.addEventListener('change', function(event) {
	
		log_msg("Year chg <br>");
		
		
				
					//table.filterBySelectionEnabled = false;
					//table.highlightIds.removeAll()
				
				
				const selected_yr = event.target.value;
				log_msg(selected_yr);
				
				var query = new Query();
				var where_q = `Date_Yr = ${selected_yr}`
				
					log_msg("<br>");
					log_msg(where_q);
				
					if (selected_yr == "All"){
						where_q = "1=1"
						ride_attr.definitionExpression = "1=1";
					} else {
	
						log_msg("bb<br>");
						log_msg(where_q);	
						
						query.where = where_q
						
						
						ride_attr.queryFeatures(query).then((results) => {
							log_msg("<br>res...");
							ride_attr.definitionExpression = where_q;
							log_msg('<br>fin');
							
						});
						
					}
					
				table.refresh();
			
			
			
			
	});




}); // End require(FeatureTable)
	

	
	
	
	function zoom_to_tblSelect(){
		table.zoomToSelection();
	}

	function do_stuff(){
		log_msg(table.highlightIds.length);
	}
	

	
	

// simple handler to show/hide the div with table.
	function table_handler() {
		if(table_toggle){
			var tableDiv = document.getElementById('tableDiv');
			tableDiv.style.visibility = 'visible';

			var mapDiv = document.getElementById('mapDiv');
			mapDiv.style.height = '48%';
		
			table_toggle = false;		
		} else {
				table_toggle = true; 
				
				var tableDiv = document.getElementById('tableDiv');
				tableDiv.style.visibility = 'hidden';

				var mapDiv = document.getElementById('mapDiv');
				mapDiv.style.height = '100%';
		}	
	}
	
var layer_toggle = true;
// simple handler to show/hide div with Layer controls
	function layer_handler() {
		if(layer_toggle){
			var layerDiv = document.getElementById('layer_bar');
			layerDiv.style.visibility = 'hidden';
			layer_toggle = false;		
		} else {
			var layerDiv = document.getElementById('layer_bar');
			layerDiv.style.visibility = 'visible';
			layer_toggle = true;		
		}	
	}
			
	// prints string to 'console' on the HTML page
	function log_msg (msg) {
		document.getElementById("my_console").innerHTML += msg;
	} 
	function clr_con (){
		document.getElementById("my_console").innerHTML = 'Logging...<br>';
	}

	
	
	window.addEventListener('resize', () => {
		var chk_width = document.getElementById('page_div').offsetWidth;
		width_handler(chk_width);
	});
	
	function width_handler(chk_width){
		// function to hide some css elements on small screens;
		// called after mapView.when(); and on window resize;
		
		var basemap_bar = document.getElementById('basemap_bar');		
		var sm_mapDiv = document.getElementById('mapDiv');
		
		if ( chk_width <= 500 ){
			basemap_bar.style.visibility = 'hidden';
			sm_mapDiv.style.width = chk_width;
			
		} else {
			basemap_bar.style.visibility = 'visible';
			sm_mapDiv.style.width = '';
		}	
	}
	 
	 
	 
	 
	 
	 
	 
	 
	

</script>
	
  </head>

  <body>
  <!-- viewport container -->
 <div class="page_div" id="page_div">
  
    <!-- map container -->
	<div class="mapDiv" id="mapDiv">
		<div class="layer_bar" id="layer_bar">
			<input type="checkbox" class="layer_chk" style="visibility:hidden"       /> <span class="layer_desc" style="font-weight:bold;">Layer Name   </span>&nbsp;&nbsp;Opacity<br>
			<input type="checkbox" class="layer_chk" id="rides_2020_lyr_chk" checked /> <span class="layer_desc" style="font-weight:bold;color:#1b9e77">Rides 2020</span> &nbsp;<input id="rides_2020_opac_slide" type="range" min="0" max="100" value="100" class="lyr_slide"><br>
			<input type="checkbox" class="layer_chk" id="rides_2021_lyr_chk" checked /> <span class="layer_desc" style="font-weight:bold;color:#7570b3">Rides 2021</span> &nbsp;<input id="rides_2021_opac_slide" type="range" min="0" max="100" value="100" class="lyr_slide"><br>
			<input type="checkbox" class="layer_chk" id="rides_2022_lyr_chk" checked /> <span class="layer_desc" style="font-weight:bold;color:#d95f02">Rides 2022</span> &nbsp;<input id="rides_2022_opac_slide" type="range" min="0" max="100" value="100" class="lyr_slide"><br>
			<input type="checkbox" class="layer_chk" id="rides_2023_lyr_chk" checked /> <span class="layer_desc" style="font-weight:bold;color:#e7298a">Rides 2023</span> &nbsp;<input id="rides_2023_opac_slide" type="range" min="0" max="100" value="100" class="lyr_slide"><br>
		</div>
		<div class="basemap_bar" id="basemap_bar">
  		  <form name="basemap_selector">
			<input type="radio" id="base_map" name="base_map" value="topo" checked>Topo <br>
			<input type="radio" id="base_map" name="base_map" value="hybrid">Hybrid <br>
			<input type="radio" id="base_map" name="base_map" value="streets">Streets<br>
			    <hr />
			<button type="button" onclick="layer_handler();" style="width:100px">Layers</button>
			<button type="button" onclick="legend_handler();" style="width:100px">Legend</button>
		    <button type="button" onclick="table_handler();" style="width:100px">Table</button>	  
		  </form>
		</div>
		
	</div> <!-- end map container -->
	
	<!-- righthand pane -->
  	<div class="console_div" id="console_div">
		<div class="console_log" id="my_console">
		Logging....
		</div>
	</div>

	<!-- table pane -->
	<div id="tableDiv" name="tableDiv" class="tableDiv">
		<div class="tableControl">

			<div class="tableControl_left">				
				<select id="tbl_yr" name="tbl_yr" class="tbl_tab">
					<option value="All" >All Years</option>
					<option value="2024">2024</option>
					<option value="2023">2023</option>
					<option value="2022">2022</option>
					<option value="2021">2021</option>
					<option value="2020">2020</option>
					<option value="2019">2019</option>
					<option value="2018">2018</option>
				</select>
				<input type="checkbox" class="select_chk" id="tbl_select_chk" /> Filter table by Selection?</span>
			</div>
				
			<div class="tableControl_content">
				<button type="button" onclick="do_stuff();" class="tbl_btn">Do Stuff</button>
				<button type="button" onclick="zoom_to_tblSelect();" class="tbl_btn" id="zoomTo_btn">Zoom to Selection</button>	  	
			</div>
		</div>
		
		<div id="tableContainer" class="tableContainer">
				
		</div>
	</div>


	
</div> <!-- end pageDiv --> 



  </body>
</html>