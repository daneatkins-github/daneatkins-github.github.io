
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>CoCR Infrastructure Viewer</title>


    
<!-- custom styles / page layout -->
<style>
	
/* Utility Classes */
		.hidden {
			visibility: hidden;
		}
		.display_none {
			display:none;
		}
		.loader {
			position:fixed;
			height:100%; width:100%;
			background-color:white;
			z-index:9999;
			align-content:center;
			justify-content:center;
			
			font-size:24px;
		}

/* Filter Styles */
	#filter-modal {
		width:300px;
		position:absolute;
		left:65px;
		top:70px;
		padding:3px;
		margin:auto;
		background-color:#F79D00;
		z-index:901;
		
		max-height:60%;
		overflow-y:auto;
		border:2px solid #A84420;
		
	}
	.filter_close_modal_btn {
		cursor:pointer;
		font-weight:bold;
		border:1px solid black;
		background-color:red;
		height:21px;
		margin-left:3px; margin-top:3px;
		align-content:center;
		float:right;
	}
	.filter_close_modal_btn:hover {
		background-color: #8C1801;
	}
	.filter_layerItem {
		font-size:12px;
		margin:3px;
		padding:3px;
		border: 1px solid black;
		background-color: #FFF0D7
	}
	.filter_remove_btn {
		cursor:pointer;
		font-size:10px;
		border:1px solid black;
		background-color:red;
		height:16px;
		margin-left:3px; margin-top:3px;
		float:right;
		padding-left:2px;
		padding-right:2px;
	}
	.filter_remove_btn:hover {
		background-color: #8C1801;
	}
	
	.arcgis-filter {
		position:absolute;
		top:16px;
		left:55px;
		z-index:987;
		
		cursor:pointer;
		padding:3px;
		background-color:orange;
		border:1px solid red;
	}

/* header dropdown menu */

	.header_menu_btn {
		position:absolute;
		right:0px;
		top:0px;
		
		cursor:pointer;
		align-content:center;
		border-top-left-radius:12px;
		height:100%;
		width:160px;

		border-left:1px solid black;
		background-color:wheat;
		
	
	}
	.header_menu_btn:hover{
		background-color:tan;
	}
	
	
	.header_menu_content {
		position:absolute;
		right:0px;
		top:0px;
		border-left: 1px solid black;
		border-bottom: 1px solid black;
		
		width:160px;
		background-color:wheat;
		z-index:999
	}
	.header_menu_content_item {
		cursor:pointer;
		justify-content:right;
		border-top: 1px solid black;
		font-size:12px;
		padding-left:5px;
		padding-right:5px;
		z-index:9999
	}
	.header_menu_content_item:hover {
		background-color:tan;
	}



	
/* Main Layout Template */

	*{
		margin: 	0px;
		padding: 	0px;
	}
	#header{
		position: 	fixed;
		top: 		0px;
		width: 		100%;
		height: 	50px;
		background-color: green;
		text-align:center;
		align-content:center;
		white-space:nowrap;
		overflow:none;
	}
	.header_title {
		position:absolute;
		top:0px;
		left:15px;
		align-content:center;
		
		height:50px;
		font-size:24px;
		
		border-top-right-radius:12px;
		border-bottom-right-radius:12px;
		border-top-left-radius:12px;
		border-bottom-left-radius:12px;

		padding-left: 25px; padding-right: 25px;

		background-color: lightgreen;
		white-space:nowrap;
		
	}
	
	
		
	
	
	#content {
		position: 	fixed;
		top: 		50px;
		left:		0px;
		right:		0px;
		overflow: 	hidden;
		
		background-color: gray;
	}
	
	#content_main {
		position:	fixed;
		top:		50px;
		right: 		0px;
		background-color:white;
		z-index: 150;
		
	}
	.content_width_sidebarOpen {
		left:		360px;
	}
	.content_width_sidebarClosed {
		left:		30px;
	}
	.content_height_footerOpen {
		bottom:		300px;
	}
	.content_height_footerClosed {
		bottom:		40px;
	}
	
	#map_main {
		z-index:200;
	}
	
/* Sidebar Open Closed */
	#content_leftSidebar_open {
		position:	fixed;
		top:		50px;
		width:		360px;
		background-color: 	lightblue;
	}

	#layer-list{
		overflow:auto;
		height:calc(100% - 28px);
	}
	.sidebar_collapse_btn {
		text-align:right;
		padding-right:15px;
		cursor:pointer;
		height:28px;
		background-color:lightblue;
	}
	.sidebar_collapse_btn:hover{
		background-color:#03b1fc;
	}

	#content_leftSidebar_closed {
		position:	fixed;
		top:		50px;
		width:		30px;
		
		background-color: lightblue;
	
	}	
	.sidebar_expand_btn {
		font-size:1.1em;
		height:100%;
		text-align:center; 
		writing-mode: vertical-lr;
		cursor:pointer;
		background-color:lightblue;
	}
	.sidebar_expand_btn:hover {
		background-color:#03b1fc;
	}
	.sidebar_height_footerOpen {
		bottom: 300px;
	}
	.sidebar_height_footerClosed {
		bottom: 40px
	}
	
	
	
	#footer{
		position: 	fixed;
		bottom: 	0px;
		width: 		100%;
		background-color:lightgray;
		
	}
	.footer_open {
		height: 	300px;
	}
	
	.footer_closed {
		height:		40px;
	}
	
	.footer_enlarged {
		top:		50px;
		height: calc(100% - 50px)
	}


	/* Footer Menu Tabs */
		.tab {
		  overflow: hidden;
		  border: 1px solid #ccc;
		  background-color: #f1f1f1;
		  display:flex;
		  flex-wrap:nowrap;
		  justify-content:right;
		}
		
		/* Style the buttons inside the tab */
		.tab button {
		  height:37px;
		  background-color: inherit;
		  border: none;
		  outline: none;
		  cursor: pointer;
		  padding: 10px 16px;
		  transition: 0.3s;
		  font-size: 17px;
		  border-left: 1px solid black;
		}

		/* Change background color of buttons on hover */
		.tab button:hover {
		  background-color: #ddd;
		}

		/* Create an active/current tablink class */
		.tab button.active {
		  background-color: #ccc;
		}

		/* Style the tab content */
		.tabcontent {
		  display:none;
		  padding: 6px 12px;
		  overflow:auto;
		}

		.tab_height_normal {
			height: 250px;
		}
		.tab_height_enlarge {
			height: calc(100% - 50px);
		}
		
		#feature-table {
			height:100%;
		}

</style>

	
<!-- ArcGIS Import -->
<script type="module" 		src="https://js.arcgis.com/calcite-components/3.2.1/calcite.esm.js"></script>
<link 	rel="stylesheet" 	href="https://js.arcgis.com/4.33/esri/themes/light/main.css" />
<script 					src="https://js.arcgis.com/4.33/"></script>
<script type="module" 		src="https://js.arcgis.com/4.33/map-components/"></script>


	
</head>

<body>
  
  <!-- viewport container -->
  <div class="loader" id="loader">
	  <div style="width:100vw;text-align:center;">
		Loading the City of Cedar Rapids' <br>
		Infrastructure Viewer
	 </div>
	<calcite-loader label="Loading application" scale="l"></calcite-loader>
  </div>
  
 <div class="page_div">
 
 		<div id="filter-modal" class="display_none">
			<div style="text-align:center;">Configure Filters:
				<div id="filter_close_btn" class="filter_close_modal_btn">&nbsp;X&nbsp;</div>
			</div>
			<div id="filter-container">
			
			</div>
			<div style="float:right;">
				<button id="disable_filters_btn">&nbsp;Disable Filters&nbsp;</button>
				<button id="apply_filters_btn"  >&nbsp;Apply Filters&nbsp;</button>
			</div>
			
		</div>
 
 <div id="header">
	<span class="header_title">
	City of Cedar Rapids' Infrastructure Viewer 
	</span>
	

	
		<div class="header_menu_btn" id="header_menu_btn">
			Bookmarked Views
		</div>

	
</div>
<div id="content" class="">

			
	<div id="content_leftSidebar_open" class="sidebar_height_footerClosed">
		<div id="sidebar_collapse_btn" class="sidebar_collapse_btn"><<< Hide Layer List</div>
		<arcgis-layer-list id="layer-list" reference-element="map_main" position="top-right"></arcgis-layer-list>	
	</div>

	<div id="content_leftSidebar_closed" class="sidebar_height_footerClosed display_none">
		<div id="sidebar_expand_btn" class="sidebar_expand_btn">Expand Layer List</div>
	</div>
	
	<div id="content_main" class="content_width_sidebarOpen content_height_footerClosed">

		<arcgis-map id="map_main" basemap="topo" style="z-index:200;">
		  <!-- basic buttons -->
		  <arcgis-home    position="top-left"></arcgis-home>
		  <arcgis-compass position="top-left"></arcgis-compass>
		  <arcgis-zoom    position="top-left"></arcgis-zoom>
		  
		  <calcite-icon icon="filter" scale="m" title="Active Filters" id="active_filters_btn" class="arcgis-filter display_none"></calcite-icon>

		  <!-- map top-right -->
		  <arcgis-expand id="expand_search" position="top-left">
			<arcgis-search></arcgis-search>
		  </arcgis-expand>
		  <arcgis-scale-bar position="bottom-right" unit="dual" style="z-index:400;"></arcgis-scale-bar>
		  

		  <!-- Map bottom-left -->
		  <arcgis-expand id = "expand_measure" position="bottom-left" mode="floating">
			<arcgis-distance-measurement-2d position="top-right"></arcgis-distance-measurement-2d>				  
		  </arcgis-expand>
		  <arcgis-expand id="expand_coords"  position="bottom-left" mode="floating">
			<arcgis-coordinate-conversion position="bottom-left" hide-expand-button></arcgis-coordinate-conversion>
		  </arcgis-expand>
		  <arcgis-expand id="expand_sketch"  position="bottom-left" mode="floating">
			<arcgis-sketch    position="bottom-left"></arcgis-sketch>
		  </arcgis-expand>
		  <arcgis-expand id="expand_print"   position="bottom-left" mode="floating">
			<arcgis-print></arcgis-print> <!-- 'arcgis-print' generates 'undefined' error in Console.log -->
		  </arcgis-expand>				  
		  
		  <!-- Map bottom-right -->
		  
		 </arcgis-map>
		 
		 
		<div id="header_menu_content" class="header_menu_content display_none">
			<div class="header_menu_content_item" id="projects">CIP Project Tracking</div>
			<div class="header_menu_content_item" id="streets" >Streets Maintenance</div>
			<div class="header_menu_content_item" id="mowing"  >Mowing Responsibility</div>
			<div class="header_menu_content_item" id="snowops" >Snow Operations</div>
			<div class="header_menu_content_item" id="water"   >Water Utilities</div>
			<div class="header_menu_content_item" id="sanitary">Sanitary Sewer</div>
			<div class="header_menu_content_item" id="storm"   >Storm Sewer</div>
		</div>
	</div>
	
	

</div>

<div id="footer" class="footer_closed">

	<div class="tab">

	  <button class="tablinks" id="tablink_Basemaps"	>Basemaps</button>
	  <button class="tablinks" id="tablink_Legend"		>Legend</button>
	  <button class="tablinks" id="tablink_Tables"	disabled	>Tables</button>
	  <button class="tablinks display_none" id="tablink_Enlarge"	title="Enlarge"	>&#8657; </button>
	  <button class="tablinks display_none" id="tablink_Shrink"		title="Shrink"	>&#10585;</button>
	  <button class="tablinks display_none" id="tablink_Collapse"	title="Collapse">&#8659;</button>
	</div>
	
	
	<div class="tabcontent tab_height_normal display_none" id="tab_Basemaps"	>
		<arcgis-basemap-gallery reference-element="map_main" auto-destroy-disabled></arcgis-basemap-gallery>	  
	</div>
	<div class="tabcontent tab_height_normal display_none" id="tab_Legend"	>
		<arcgis-legend id="legend" reference-element="map_main" auto-destroy-disabled></arcgis-legend>
	</div>
	<div class="tabcontent tab_height_normal display_none" id="tab_Tables"	>
		<arcgis-feature-table id="feature-table" reference-element="map_main" class="table_height_normal" show-layer-dropdown></arcgis-feature-table>
	</div>
	
</div>
</div> <!-- end pageDiv --> 


<script type="module">
// Globals:
var visible_layers = [] 
var all_layers = []
var popup_defaultDisabled = [902, 903, 907, 908, 906, 904]





document.addEventListener('DOMContentLoaded', async function() {



// DOM FUNCTION DEFINITIONS //

// Layout Functions
	var footer_state = 'collapse'
	var footer_activeTab = null
	
	function sidebar_collapse(){
		document.getElementById("content_leftSidebar_open").classList.add("display_none");
		document.getElementById("content_leftSidebar_closed").classList.remove("display_none");
		document.getElementById("content_main").classList.add("content_width_sidebarClosed");
		document.getElementById("content_main").classList.remove("content_width_sidebarOpen");
	}
	function sidebar_expand(){
		document.getElementById("content_leftSidebar_open").classList.remove("display_none");
		document.getElementById("content_leftSidebar_closed").classList.add("display_none");
		document.getElementById("content_main").classList.remove("content_width_sidebarClosed");
		document.getElementById("content_main").classList.add("content_width_sidebarOpen");
	}
	function footer_handler(new_state){
		function footer_expand(){
			document.getElementById("content_main").classList.add("content_height_footerOpen");
			document.getElementById("content_main").classList.remove("content_height_footerClosed");

			document.getElementById("content_leftSidebar_open").classList.remove("sidebar_height_footerClosed");
			document.getElementById("content_leftSidebar_closed").classList.remove("sidebar_height_footerClosed");
			document.getElementById("content_leftSidebar_open").classList.add("sidebar_height_footerOpen");
			document.getElementById("content_leftSidebar_closed").classList.add("sidebar_height_footerOpen");

			document.getElementById("tablink_Shrink").classList.add("display_none");
			document.getElementById("tablink_Collapse").classList.remove("display_none");
			document.getElementById("tablink_Enlarge").classList.remove("display_none");
			document.getElementById("footer").classList.remove("footer_enlarged");
			document.getElementById("footer").classList.add("footer_open")
			document.getElementById("footer").classList.remove("footer_closed")
			
			document.getElementById("feature-table").classList.remove("table_height_enlarge")
			document.getElementById("feature-table").classList.add("table_height_normal")
			
			var i, tabcontent, tablinks;
			tabcontent = document.getElementsByClassName("tabcontent");
			for (i = 0; i < tabcontent.length; i++) {
				tabcontent[i].classList.add("tab_height_normal")
				tabcontent[i].classList.remove("tab_height_enlarge")
			}
		}
		function footer_collapse(){
			document.getElementById("content_main").classList.remove("content_height_footerOpen");
			document.getElementById("content_main").classList.add("content_height_footerClosed");

			document.getElementById("content_leftSidebar_open").classList.add("sidebar_height_footerClosed");
			document.getElementById("content_leftSidebar_closed").classList.add("sidebar_height_footerClosed");
			document.getElementById("content_leftSidebar_open").classList.remove("sidebar_height_footerOpen");
			document.getElementById("content_leftSidebar_closed").classList.remove("sidebar_height_footerOpen");

			
			document.getElementById("tablink_Shrink").classList.add("display_none");
			document.getElementById("tablink_Collapse").classList.add("display_none");
			document.getElementById("tablink_Enlarge").classList.add("display_none");
			document.getElementById("footer").classList.remove("footer_open")
			document.getElementById("footer").classList.remove("footer_enlarged");
			document.getElementById("footer").classList.add("footer_closed")	

			document.getElementById("feature-table").classList.remove("table_height_enlarge")
			document.getElementById("feature-table").classList.add("table_height_normal")
		}		
		function footer_enlarge(){
			document.getElementById("feature-table").classList.add("table_height_enlarge")
			document.getElementById("feature-table").classList.remove("table_height_normal")
			
			document.getElementById("footer").classList.add("footer_enlarged");
			document.getElementById("tablink_Enlarge").classList.add("display_none");
			document.getElementById("tablink_Shrink").classList.remove("display_none");

			var i, tabcontent, tablinks;
			tabcontent = document.getElementsByClassName("tabcontent");
			for (i = 0; i < tabcontent.length; i++) {
				tabcontent[i].classList.remove("tab_height_normal")
				tabcontent[i].classList.add("tab_height_enlarge")
			}
			
		}
	
		footer_state = new_state
		if (new_state === 'enlarge'){
			footer_enlarge()
			return
		}
		if (new_state === 'expand'){
			footer_expand()
			return
		}

		footer_collapse()
	} // end footer_handler

	
	function openTab(evt, tabName) {
		// W3 tab-nav standard; used for Footer/ tabs menus
		console.log(tabName);
	  var i, tabcontent, tablinks;
	  tabcontent = document.getElementsByClassName("tabcontent");
	  for (i = 0; i < tabcontent.length; i++) {
		tabcontent[i].style.display = "none";
	  }
	  tablinks = document.getElementsByClassName("tablinks");
	  for (i = 0; i < tablinks.length; i++) {
		tablinks[i].className = tablinks[i].className.replace(" active", "");
	  }
	  
	  if (tabName){
		  document.getElementById(tabName).style.display = "block";
		  evt.currentTarget.className += " active";
		  footer_activeTab = tabName;
	  } else {footer_activeTab = null}
	}	

	function define_layout_events(){
		// Sidebar Toggler
		document.getElementById("sidebar_collapse_btn").addEventListener("click", 	function() {	sidebar_collapse()		})
		document.getElementById("sidebar_expand_btn").addEventListener('click', 	function() {	sidebar_expand()		})

		// Footbar Toggler 'click' Events
		var tablinks = document.getElementsByClassName("tablinks");
		for (var i = 0; i < tablinks.length; i++) {
			tablinks[i].addEventListener("click", function() {

				var source = event.target.id
				var target = source.replace('link', '');
				
				if (target === footer_activeTab){
					console.log('same tab')
					footer_handler('collapse'); openTab(event, null)
				} else {

					if (source != "tablink_Collapse" && source != "tablink_Enlarge" && source != "tablink_Shrink"){
					
						openTab(event, target) 
						if (footer_state === "collapse"){footer_handler('expand')}
						
					} else {
						if (source === "tablink_Collapse"){footer_handler('collapse'); openTab(event, null)}
						if (source === "tablink_Shrink"){footer_handler('expand')}
						if (source === "tablink_Enlarge"){footer_handler('enlarge')}
					}
				
				}
			})
		}
		
		// header dropdown
		document.getElementById("header_menu_btn").addEventListener("click", function() {
			document.getElementById("header_menu_content").classList.toggle("display_none");
		})
		document.addEventListener("click", function(evt){  // general: if not click to open header menu, close header.
			var header_menu = document.getElementById("header_menu_content")
			var header_btn  = document.getElementById("header_menu_btn")
			if (evt.target != header_menu && evt.target != header_btn){
				header_menu.classList.add('display_none')
			}
		})
		 // list of 'menu items' and their action:
		for (let hdr_item of header_menu_content.children){
			hdr_item.addEventListener("click", function(evt){  // event for each header_menu_item.
				load_map_bookmark(evt.target.id)
			})
		}
	}
	
	

	


	async function load_esriConfig(){
		const esriConfig = await $arcgis.import("@arcgis/core/config.js");
		esriConfig.portalUrl = "https://crgis.cedar-rapids.org/arcgisportal/";
		
		console.log("Portal set.");
	}	
	
	async function map_init(){
		var map_element = document.querySelector("arcgis-map")
		var webmap_id   = "1c82087191d7448ba521adf7c620826e"
		
		map_element.itemId = webmap_id;
		map_element.center = [-91.65074851467115, 41.976330102403125]
		map_element.zoom = 2
		

	}


	// CALL LAYOUT FUNCTIONS
		define_layout_events()
		await load_esriConfig();
		map_init()



	// Map, onReady.
	var map_element = document.querySelector("arcgis-map");
	await map_element.viewOnReady();
	console.log("viewOnReady");
	var active_filters = []

	async function apply_filters(){
		console.log("Iterating over "+active_filters.length+" active filters.")
		active_filters.forEach(function(filter) {
			if (filter != null){
				var def_expr = ''
				
				var field = filter.field_selector_element.value.split(",")[1]
				var field_type = filter.field_selector_element.value.split(",")[2]
				var value = filter.value_selector.value
				if (field_type == 'string'){value = "'" + value + "'"}
				
				
				var operator = filter.comparators.value.split(",")[1]
				if (operator === "is not"){operator = " <> "}
				if (operator === "is")    {operator = " = "}
				def_expr = `${field} ${operator} ${value}`		// basic construction
				
				
				if (operator === "is any of") {  // is any of multiple in list.
					var join_str;
					
					if (field_type == "string"){
						operator = " IN ('";
						join_str = "','";
					} else {
						operator = " IN (";
						join_str = ",";
					}
					
					var values = Array.from(filter.value_selector.selectedOptions).map(option => option.value);
					if (values.length < 1){def_expr = null} // no values selected.
					if (values.length == 1){} 				// do nothing, use basic construction.
					if (values.length > 1){
						value = values.join(join_str)
						def_expr = `${field} ${operator}${value}`		
						if (field_type == "string"){
							def_expr += "')"
						} else { def_expr += ")" }
					}
				}
				
				
				console.log(def_expr);
				filter.definitionExpression = def_expr;
				
				document.getElementById("active_filters_btn").classList.remove("display_none");
				
				console.log(filter)
			}
		})
	}
	async function disable_filters(){
		//removes all DefinitionExpressions, all layers...
		console.log("removing filters");
		active_filters.forEach(function(filter) {
			if (filter != null){
				filter.definitionExpression = null
			}
		})
		document.getElementById("active_filters_btn").classList.add("display_none");

	}

	// filter_modal
	async function filter_modal(from_layer){
	// function to create and handle a filtering modal with an 'array' of filters.
		
		// show the modal
		var filter_window = document.getElementById("filter-modal");
		var filter = document.getElementById("filter-container")
		filter_window.classList.remove("display_none");

		var i = -1
		
		// tracking filters:
		if (!active_filters.includes(from_layer)){ // if not active, create;
			active_filters.push(from_layer)
			i = active_filters.indexOf(from_layer);
			active_filters.index = i;
			console.log('adding new filter, index ' + i);
				
			// creating 
			active_filters[i].title = from_layer.title
		
			active_filters[i].field_selector = document.createElement('select');
			active_filters[i].field_selector.id = "filter_fieldlist_" + i.toString()
			
			active_filters[i].value_selector = document.createElement('select');
			active_filters[i].value_selector.id = "filter_valuelist_" + i.toString()
			active_filters[i].value_selector.style.width = "220px"
			
			// field selector options:
			active_filters[i].field_options = ''
			from_layer.fields.forEach( function(field) {
				if (!['OBJECTID', 'objectid', 'shape', 'SHAPE', 'Shape'].includes(field.name)){
					active_filters[i].field_options += '<option value="'+i+',' + field.name + ','+field.type+'">'+field.alias+'</option>'
				}
			})
			active_filters[i].field_selector.insertAdjacentHTML("beforeend", active_filters[i].field_options)
			
			// standard comparators options
			var comparators = ['is', 'is not', 'is any of'];
			var std_comp = ''
			active_filters[i].comparators = document.createElement('select');
			active_filters[i].comparators.id = "filter_comparator_" + i.toString();
			comparators.forEach( function(val) {
				std_comp += '<option value="'+i+','+val+'">'+val+'</option>'
			})
			active_filters[i].comparators.insertAdjacentHTML("beforeend", std_comp)
						
			var top_content = "<div id='filter_layer_item" +i+"' class='filter_layerItem'>"+active_filters[i].title
			top_content += "<div class='filter_remove_btn' id='remove_filter_"+i+"'>X</div>"
			top_content += "<br></div>"
			filter.insertAdjacentHTML("beforeend", top_content)
			var filter_item = document.getElementById("filter_layer_item"+i)
			  filter_item.appendChild(active_filters[i].field_selector);
			  filter_item.appendChild(active_filters[i].comparators);
			  filter_item.insertAdjacentHTML("beforeend", "<br>");
			  filter_item.appendChild(active_filters[i].value_selector)
			  
			// listener for 'remove' button event;
			active_filters[i].removeButton = document.getElementById('remove_filter_'+i)
			active_filters[i].removeButton.value = i;
			active_filters[i].removeButton.addEventListener("click", async function(e) {
				var index = e.target.value
				// delete entire dom element 'filter_layer_item + i'
				var target_filter = "filter_layer_item" + index.toString()
				var target_element = document.getElementById(target_filter).remove()
				
				// null any definitionExpression;
				active_filters[i].definitionExpression = null
				
				// nullify in filter array;
				active_filters[i] = null
				console.log('Removed '+target_filter)
				
				var filtering = false;
				active_filters.forEach(function(filter){
					if (filter != null){
						filtering = true;
					}
				})
				if (!filtering){
					filter_window.classList.add("display_none")
					document.getElementById("active_filters_btn").classList.add("display_none");
				};
			})
			  
			// listen for change in comparison selector; update 'multiple'	
			active_filters[i].comparators_element = document.getElementById(active_filters[i].comparators.id);
			active_filters[i].comparators_element.addEventListener("change", async function(e) {
				const index = e.target.value.split(",")[0]
				const operator = e.target.value.split(",")[1]
				var val_selector = document.getElementById(active_filters[index].value_selector.id)
			
				if (operator === "is any of"){
					val_selector.multiple = true;
				} else {
					val_selector.multiple = false;
				}
			
			})
			
			// listen for changes in field selectors; update the values selector.
			active_filters[i].field_selector_element = document.getElementById(active_filters[i].field_selector.id);
			active_filters[i].field_selector_element.addEventListener("change", async function(e) {
				const index = e.target.value.split(",")[0]
				const layer = active_filters[index]
				const field = e.target.value.split(",")[1]

				var val_selector = document.getElementById(active_filters[index].value_selector.id)
				val_selector.disabled = true	

				
				// query for uniqueValues...
				const Query = await $arcgis.import("@arcgis/core/rest/support/Query.js");
				const curQuery = new Query();
				curQuery.where = "1=1";
				curQuery.returnDistinctValues = true;
				curQuery.outFields = [field]
				curQuery.returnGeometry = false;
				
				var uniq = []
				console.log("Getting unique values from layer/field..")
			
				layer.queryFeatures(curQuery).then((result) => {
					const uniqueValues = result.features.map(feature =>
						feature.attributes[field])
					uniq = uniqueValues

					// update values_selector for the given layer:
					val_selector.options.length = 0;
					var val_list = []
					uniq.forEach( function(val) {
						val_list += '<option value="'+val+'">'+val+'</option>'
					})
					val_selector.insertAdjacentHTML("beforeend", val_list)
					val_selector.disabled = false;
				})
			}) // end changeEvent in (field) selector
			
			// dispatch changeEvent to initialize values_selector;
			active_filters[i].field_selector_element.dispatchEvent(new Event('change'))
		} else {
			i = active_filters.indexOf(from_layer);
			console.log('active filter, index ' + i);
		}

		
		// close button and other one-time setups: (check if the event was attached to close button);
		var filter_close_btn = document.getElementById("filter_close_btn")
		if (filter_close_btn.getAttribute('listener') !== 'true') {
			filter_close_btn.addEventListener('click', function (e) {
				filter_window.classList.add("display_none");
			})
			filter_close_btn.setAttribute('listener', 'true');

			var apply_filters_btn = document.getElementById("apply_filters_btn")
			var disable_filters_btn = document.getElementById("disable_filters_btn")
			apply_filters_btn.addEventListener('click', function (e) {
				apply_filters()
			})
			disable_filters_btn.addEventListener('click', function (e) {
				disable_filters()
			})
			
			var active_filters_btn = document.getElementById("active_filters_btn")
			active_filters_btn.addEventListener('click', function (e) {
				var filter_window = document.getElementById("filter-modal");
				var filter = document.getElementById("filter-container")
				filter_window.classList.remove("display_none");
			});

		}
		
	}


	// arcgis Component config
	async function load_widget_LayerList(){	
		//LayerList Actions and Events...
		const LayerList = document.querySelector("arcgis-layer-list");
		LayerList.visibilityAppearance="checkbox"
		LayerList.dragEnabled = true;
		const [ActionButton, Collection, Slider, reactiveUtils] = 
			await $arcgis.import(["@arcgis/core/support/actions/ActionButton.js","@arcgis/core/core/Collection.js", "@arcgis/core/widgets/Slider.js", "@arcgis/core/core/reactiveUtils.js"]);

		// function executes as ListItems are added to LayerList; defines events and action
		// used to generate 'Collections' of 'our Service' and other Layer-By-Layer ops.
		LayerList.listItemCreatedFunction = (event) => {
				var  lyrList_item  = {}
				lyrList_item = event.item
				
				if (popup_defaultDisabled.includes(lyrList_item.layer.id)){
					lyrList_item.layer.popupEnabled = false;
				} 
				
				// add a Listener for Layer-By-Layer Visibility!
				reactiveUtils.watch(   () => lyrList_item.visible,	(result) => {
					console.log('reactive to item.visible')
					async function reactive_visibility(){
						visible_layers = await sublayers_IsReallyVisible(all_layers)
						update_table_layer_selector(visible_layers)
					}
					reactive_visibility()
				});

				// Action Buttons for all Layers
				var LayerList_infoButton = new ActionButton({
					title:"Layer Information",
					icon: "information",
					id:   "information"
				})
				var LayerList_filterButton = new ActionButton({
					title:"Filter Layer",
					icon: "filter",
					id:   "filter"
				})
				
				var LayerList_tableButton = new ActionButton({
					title:"View in Table",
					icon: "table",
					id:   "table",
				})
				if (lyrList_item.layer.popupEnabled){ // toggle button enable/disable popup
					var LayerList_popupButton = new ActionButton({
						title:"Disable Info Popup",
						icon: "content-none",
						id:   "popup"
					})
				} else {
					var LayerList_popupButton = new ActionButton({
						title:"Enable Info Popup",
						icon: "popup",
						id:   "popup"
					})
				}
				
				// Different buttons (and panels) for 'bottom-level' layers. (& is 'our service')
				var lyrList_url = lyrList_item.layer.url

				if ((lyrList_item.layer.url && lyrList_item.layer.url.includes("Infrastructure_Viewer")) &&   // is our service
				    (!lyrList_item.children.length > 0 && lyrList_item.parent)){  // and selection for 'individual' layer (no child).

						const slider = new Slider({
							min:0, max:1, precision:2, values: [1],
							visibleElements: {labels:true, rangeLabels:true},
						});
						
						lyrList_item.panel = {
							content: slider,
							icon: "sliders-horizontal",
							title: "Layer Transparency"
						}
						
						reactiveUtils.watch(
						  () => slider.values.map((value) => value),
						  (values) => {lyrList_item.layer.opacity = values[0]
						});

					lyrList_item.actionsSections = new Collection([
						new Collection([
							LayerList_infoButton, LayerList_filterButton, LayerList_tableButton, LayerList_popupButton
						]),
					]);

				} else {
					// all other layers:
					lyrList_item.actionsSections = new Collection([
						new Collection([
							LayerList_infoButton,
						]),
					]);
				}

				
		
			// console.log("Created " + lyrList_item.layer.title)
		} // end 'ItemCreatedFunction'; (all Layer List buttons defined.)
		
		// Event listener that fires each time a LayerList ActionButton is triggered
		LayerList.addEventListener("arcgisTriggerAction", (event) => {
			// Get a reference to the action id.
				const id = event.detail.action.id;
				const url = event.detail.item.layer.url;
				const lyr = event.detail.item.layer

			if (id === "information"){
				window.open(url);
			}
			if (id === "filter"){
				filter_modal(lyr);
			}
			if (id === "popup"){
				toggle_layer_popup(event)
			}
			if (id === "table"){
				view_layer_inTable(event)
			}
		});
	}
	
	async function view_layer_inTable(event){		
		if (footer_activeTab !== "tab_Tables"){ // be sure the Tables tab is open.
			await document.getElementById("tablink_Tables").click();
		}
		
		var table = await document.querySelector("arcgis-feature-table")
		var tbl_layer = event.detail.item.layer;

		async function set_lyr(){
			table.layer = tbl_layer;		
		}
		setTimeout(set_lyr, 50);	// delay prevents lockup of the arcgis-feature-table component.
	}
	
	
	function toggle_layer_popup(event){
		if (event.detail.item.layer.popupEnabled){
			// popup was enabled: disable popup and set button to 'enable'
			event.detail.action.title = "Enable Info Popup";
			event.detail.action.icon = "popup";
			event.detail.item.layer.popupEnabled = false;
		} else {
			// popup was disabled: enable.
			event.detail.action.title = "Disable Info Popup";
			event.detail.action.icon = "content-none";
			event.detail.item.layer.popupEnabled = true;
		}
	}


	// Primary Layers, load and management

	async function sublayers_IsReallyVisible(in_collection){
	  // Evaluates a sublayers collection, considers inherited 'group-layer' visibility, etc updating data-widgets.
		//expects a collection of sublayers from .allSublayers method
		
		let visible_array = []
		
		for (var sublyr of in_collection){
			sublyr.IsReallyVisible = sublyr.visible	  // initialize visibility based on .visible (and next, on .parent.IsReallyVisible)

			if (!sublyr.parent.IsReallyVisible){  // if the parent evaluated 'false'... then the child is visible false, too
				sublyr.IsReallyVisible = false    // required whether or not we 'push' the layer (pass the visibility down-tree)
			}  						
					
			if (sublyr.IsReallyVisible){
				if(!sublyr.sublayers){			  // if the layer has sublayers, it's probably not a Feature/data layer!
					visible_array.push(sublyr); 
				}
			}
		}

	return visible_array
	}

	async function update_table_layer_selector(in_layers){
		var table = document.querySelector('arcgis-feature-table')
		table.layers = in_layers
		table.layer = in_layers[0]
	}

	async function load_featureTable(){
		var table = document.querySelector("arcgis-feature-table");
		console.log('Starting table menu-config')
		table.menuConfig = {
			items: [
				{ // "Export Table" Menu Item
					label:"Export table", icon: "download", clickFunction: () => {
						var old_highlights = JSON.parse(JSON.stringify(table.highlightIds)) 	// save current selection
						table.layer.queryObjectIds().then(function(results){					// query all features
							table.highlightIds = results
							table.exportSelectionToCSV().then(function(){					// export to CSV,
								if (old_highlights && old_highlights.length){
									table.highlightIds = old_highlights						// restore orig selection
								} else {
									table.highlightIds = []									// or remove all selection
								}
							});
						})	
					}
				},
				{ // "Select All" Menu Item
					label: "Select all", icon: "selection", clickFunction: () => {
						table.layer.queryObjectIds().then(function(results){					// query all features
							table.highlightIds = results										// set selection
						})	
					} 
				}
			]
		} // end Table menuConfig
		console.log("Finished table menu-config");
	}

	async function get_primary_layers(){
		// evaluate top-level services, find 'our service', update sublayer IsReallyVisible, remove 'Sketch Layer'
		  // update feature-table layer selector; add EventListener for layer.visible changes.

		var our_service = "crgis.cedar-rapids.org/arcgisserver/rest/services/InfraView/Infrastructure_Viewer_Monolithic_Service"
		const Collection = await $arcgis.import("@arcgis/core/core/Collection.js");
		
		var mapView = document.querySelector("arcgis-map")
		
		let map_lyr_collection = mapView.map.allLayers.flatten(function(item){
			return item.layers || item.sublayers;
		});
		
		map_lyr_collection.forEach(function(item, i){ 		
			// only handle "our service" for now.
			if (item.url){
				if ( (item.url).includes(our_service) ){

					// queue up 'IsReallyVisible' to fire after load:		
					item.on("layerview-create", async function(event){
						var sublayers = event.layerView.layer.allSublayers.reverse()
						all_layers = sublayers;
						event.layerView.layer.IsReallyVisible = true;

						visible_layers = await sublayers_IsReallyVisible(sublayers)
						await update_table_layer_selector(visible_layers)

						document.getElementById("tablink_Tables").disabled = false
					})
				}  // end if url = 'our service'
			}  // end if url:true
			
			if (item.title === "Sketch Layer"){
				item.listMode = "hide"
			}
		}); //end mapView.layers.forEach
		
	}


load_widget_LayerList();
get_primary_layers();
load_featureTable();



	function load_map_bookmark(bookmark){
		// bookmark is a list of integers in InfraView Service to enable; 
		// all external layers disabled.
		console.log("loading from bookmark");
		
		var enableLayers = [600, 859, 905, 908, 852, 851]  // default;
		if (bookmark === "projects"){enableLayers = [600, 859, 905, 908, 852, 851, 999]}
		if (bookmark === "mowing")  {enableLayers = [897, 898, 861, 863, 864, 865, 905, 908, 999]}
		if (bookmark === "streets") {enableLayers = [897, 899, 772, 776, 905, 908, 999]}
		if (bookmark === "snowops") {enableLayers = [897, 900, 727,  24, 721, 724, 905, 908, 999]}
		
		if (bookmark === "water")   {enableLayers = [101, 120, 87, 88, 92, 108, 119, 905, 908, 999 ]}
		if (bookmark === "sanitary"){enableLayers = [101, 5,   6, 7, 9, 10, 11, 12, 905, 908, 999]}
		if (bookmark === "storm")   {enableLayers = [101, 71, 70, 0, 2, 3, 905, 908, 999]}
		
	
		// use layerList items to walk; 'open' lyrList_item.open, 'visible' lyrList_item.layer.visible
		var lyrList = document.querySelector('arcgis-layer-list');
		var lyrs = lyrList.operationalItems;
		
		//recursive function to check lyrList_item children.
		async function bookmark_check(in_layer){
			// if we have children, call the function again.
			if (in_layer.children){
				in_layer.children.items.forEach(function(child){
					bookmark_check(child)
				})
			}
			
			// children or no, check *this* layer; 
			if (enableLayers.includes(in_layer.layer.id)){
				in_layer.layer.visible= true;
				in_layer.open = true;
			} else {
				in_layer.layer.visible= false;
				in_layer.open = false
				if (!in_layer.parent){in_layer.layer.visible=true; in_layer.open=true;} //top-level exception.
			}
		}

		lyrs.forEach(function(lyr, i){
			if (lyr.layer.url && lyr.layer.url.includes("Infrastructure_Viewer")){ // only bookmark 'local' services.
				bookmark_check(lyr); // check this layer and all of its children...
			}
		})
		
		// bookmarks should appear as URL parameters for users to 'share':
		const url_base = window.location.href.split('?')[0]
		const param_str = "?bookmark=" + bookmark
		if (window.history.replaceState){
			window.history.replaceState({}, null, url_base+param_str)
		
		}

	}





	// check URL params for a bookmark;
	const url_params = window.location.search
	const params     = new URLSearchParams(url_params);
	console.log(params);
	
	if (params.get("bookmark")){
		setTimeout(function() {
			load_map_bookmark(params.get("bookmark"));
		},2000);
		console.log("loaded bookmark from param");
	}

	console.log("End DOMContentLoaded Functions")
	
	setTimeout(function() {
		document.getElementById("loader").classList.add("display_none");
		}, 3500)
}); // end DOMContentLoaded







</script>



</body>
</html>