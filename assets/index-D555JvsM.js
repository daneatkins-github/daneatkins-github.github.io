(function(){const T=document.createElement("link").relList;if(T&&T.supports&&T.supports("modulepreload"))return;for(const d of document.querySelectorAll('link[rel="modulepreload"]'))b(d);new MutationObserver(d=>{for(const n of d)if(n.type==="childList")for(const B of n.addedNodes)B.tagName==="LINK"&&B.rel==="modulepreload"&&b(B)}).observe(document,{childList:!0,subtree:!0});function l(d){const n={};return d.integrity&&(n.integrity=d.integrity),d.referrerPolicy&&(n.referrerPolicy=d.referrerPolicy),d.crossOrigin==="use-credentials"?n.credentials="include":d.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function b(d){if(d.ep)return;d.ep=!0;const n=l(d);fetch(d.href,n)}})();console.log("Script; Module... running");require(["esri/Map","esri/views/MapView","esri/layers/FeatureLayer","esri/Graphic","esri/rest/support/Query"],async function(te,T,l,b,d){var n=null;function B(e,t,r,o){function s(R){return R*Math.PI/180}const i=s(e),u=s(t),p=s(r),h=s(o),{sin:y,cos:w,sqrt:S,atan2:a}=Math,x=6371,f=p-i,_=h-u,L=y(f/2)*y(f/2)+w(i)*w(p)*y(_/2)*y(_/2),ee=2*a(S(L),S(1-L));return x*ee}async function ne(e,t){var r={where:t,outFields:["*"],returnGeometry:!0},o=await e.queryFeatures(r);return o.features}function le(e,t){v.graphics.removeAll(),M.removeAll();const r={type:"point",x:e,y:t,spatialReference:{wkid:4326}};let o={type:"simple-marker",color:"green",outline:{color:"red",width:"4.5px"},style:"circle"},s=new b({geometry:r,symbol:o});v.graphics.add(s)}function re(e){const t={type:"simple-fill",color:[1,128,0,.2],outline:{color:[0,128,0,.8],width:2}},r={type:"simple-line",color:"green",width:"3px"};var o=t;for(let h=0;h<e.length;h++){e[h].geometry.type==="polyline"?o=r:o=t;var s=new b({geometry:e[h].geometry,symbol:o});M.add(s)}let i={type:"simple-marker",color:[0,0,0,0]},u=new b({geometry:n,symbol:i});if(M.add(u),e[0].layer==E){var p=e[0].geometry.extent;p.clone(),v.goTo({target:e[0],zoom:15})}else v.goTo(M.graphics)}async function N(e){console.log("Point: ",e);var t=document.getElementById("progress_bar");t.value=0;var r=13;se("off");var o=parseFloat(e.x).toFixed(4),s=parseFloat(e.y).toFixed(4);document.getElementById("near_me_header").innerHTML="<h4>Near me... &nbsp;&nbsp;&nbsp; "+s+"°N, "+Math.abs(o)+"°W",le(e.x,e.y);for(var i=document.getElementsByClassName("popup_col_val"),u=0;u<i.length;u++)i[u].innerHTML='<calcite-loader label="Fetching..." scale="s"></calcite-loader>';async function p(y,w,S,a){var x={geometry:y,spatialRelationship:"intersects",distance:S,units:a,outFields:["*"],returnGeometry:!0},f=await w.queryFeatures(x);return f.features}var h=await p(e,q,1,"feet");if(h.length>0){p(e,G,1,"feet").then(a=>{a.length>0?document.getElementById("td_quad").innerHTML=a[0].attributes.Quadrant:document.getElementById("td_quad").innerHTML="...",t.value+=1/r*100}),p(e,U,1,"feet").then(a=>{a.length>0?document.getElementById("td_councildist").innerHTML=a[0].attributes.PubName:document.getElementById("td_councildist").innerHTML="...",t.value+=1/r*100}),p(e,Y,1,"feet").then(a=>{a.length>0?document.getElementById("td_firedist").innerHTML=a[0].attributes.NAME:document.getElementById("td_firedist").innerHTML="...",t.value+=1/r*100}),p(e,Q,1,"feet").then(a=>{a.length>0?document.getElementById("td_policedist").innerHTML=a[0].attributes.DIST_NME:document.getElementById("td_policedist").innerHTML="...",t.value+=1/r*100}),p(e,j,1,"feet").then(a=>{a.length>0?document.getElementById("td_solidwaste").innerHTML=a[0].attributes.DAYWEEK:document.getElementById("td_solidwaste").innerHTML="...",t.value+=1/r*100}),p(e,F,1,"feet").then(a=>{a.length>0?(document.getElementById("td_schoolelem").innerHTML=a[0].attributes.ElementarySchool,document.getElementById("td_schoolmid").innerHTML=a[0].attributes.MiddleSchool,document.getElementById("td_schoolhigh").innerHTML=a[0].attributes.HighSchool):(document.getElementById("td_schoolelem").innerHTML="...",document.getElementById("td_schoolmid").innerHTML="...",document.getElementById("td_schoolhigh").innerHTML="..."),t.value+=3/r*100});async function y(a,x,f){console.log("Nearest Query: iterative..."),f||(f=528);var _=f,L=!1;do{var ee={geometry:a,spatialRelationship:"intersects",distance:_,units:"feet",outFields:["*"],returnGeometry:!0},I=await x.queryFeatures(ee);I.features.length>0?L=!0:_=_+_,_>15e3&&(L=!0)}while(!L);if(I.features.length>0){for(var R=20,H=!1,O=0;O<I.features.length;O++){var m=I.features[O],D=null,P=null;m.geometry.centroid&&(D=m.geometry.centroid.x,P=m.geometry.centroid.y),m.geometry.paths&&(D=m.geometry.paths[0][0],P=m.geometry.paths[0][1]),D&&P&&(m.distance=B(n.y,n.x,P,D)*.62137119,m.distance<R&&(R=m.distance,H=O))}H||(H=0);var oe=I.features.slice(H,H+1)}else var oe=!1;return oe}y(e,E,10).then(a=>{document.getElementById("td_addr").innerHTML=a[0].attributes.SITEADDRESS,t.value+=1/r*100,re(a)}),y(e,z).then(a=>{a?document.getElementById("td_parks").innerHTML=a[0].attributes.NAME:document.getElementById("td_parks").innerHTML="<span style='font-style:italic;'>... no results within 3 miles</span>",t.value+=1/r*100}),y(e,$,2500).then(a=>{a?document.getElementById("td_ssmid").innerHTML=a[0].attributes.Type:document.getElementById("td_ssmid").innerHTML="<span style='font-style:italic;'>... no results within 3 miles</span>",t.value+=1/r*100}),y(e,J,1500).then(a=>{a?document.getElementById("td_nhrplandmark").innerHTML=a[0].attributes.site_name:document.getElementById("td_nhrplandmark").innerHTML="<span style='font-style:italic;'>... no results within 3 miles</span>",t.value+=1/r*100}),y(e,V,1500).then(a=>{a?document.getElementById("td_nhrpdistrict").innerHTML=a[0].attributes.Type:document.getElementById("td_nhrpdistrict").innerHTML="<span style='font-style:italic;'>... no results within 3 miles</span>",t.value+=1/r*100}),y(e,X,1500).then(a=>{a?document.getElementById("td_cipproject").innerHTML=a[0].attributes.ProjName:document.getElementById("td_cipproject").innerHTML="<span style='font-style:italic;'>... no results within 3 miles</span>",t.value+=1/r*100});const w=window.location.href.split("?")[0],S="?xy="+o+","+s;window.history.replaceState&&window.history.replaceState({},null,w+S)}else alert("Sorry but that location appears to be outside our city!");return!0}async function se(e){var t=await document.getElementsByClassName("tr_showmore");if(e==="off"){for(var r=0;r<t.length;r++)t[r].classList.add("tr_hide");document.getElementById("tr_showmore_btn").classList.remove("tr_hide")}else{for(var r=0;r<t.length;r++)t[r].classList.remove("tr_hide");document.getElementById("tr_showmore_btn").classList.add("tr_hide")}return!0}async function ce(e){console.log("popupClick_event:",e);for(var t=document.getElementsByClassName("popup_col_val"),r=0;r<t.length;r++)t[r].classList.remove("active");M.removeAll(),W.opacity=0,K.opacity=0,g.opacity=0,g.definitionExpression=null,e.target.classList.add("active");var o=e.target.innerHTML,s=null,i=null;if(e.target.id==="td_addr")var s=E,i="SITEADDRESS";if(e.target.id==="td_solidwaste")var s=j,i="DAYWEEK";if(e.target.id==="td_quad")var s=G,i="Quadrant";if(e.target.id==="td_policedist"){var s=Q,i="DIST_NME";W.opacity=1}if(e.target.id==="td_firedist"){var s=Y,i="NAME";K.opacity=1}if(e.target.id==="td_councildist")var s=U,i="PubName";if(e.target.id==="td_schoolelem"){var s=F,i="ElementarySchool";g.definitionExpression="SUB_CLASS = 'Elementary' AND CITY = 'Cedar Rapids'",g.opacity=1}if(e.target.id==="td_schoolmid"){var s=F,i="MiddleSchool";g.definitionExpression="SUB_CLASS = 'Middle' AND CITY = 'Cedar Rapids'",g.opacity=1}if(e.target.id==="td_schoolhigh"){var s=F,i="HighSchool";g.definitionExpression="SUB_CLASS = 'High School' AND CITY = 'Cedar Rapids'",g.opacity=1}if(e.target.id==="td_parks")var s=z,i="NAME";if(e.target.id==="td_ssmid")var s=$,i="Type";if(e.target.id==="td_nhrplandmark")var s=J,i="site_name";if(e.target.id==="td_nhrpdistrict")var s=V,i="Type";if(e.target.id==="td_cipproject")var s=X,i="ProjName";if(i!=null){var u=i+" = '"+o+"'",p=await ne(s,u);re(p)}}const c=new te({basemap:"gray"}),v=new T({container:"map_div",map:c,zoom:12,center:[-91.667,41.975]});v.constraints={geometry:{type:"extent",xmin:-92.65,ymin:41.1,xmax:-90.5,ymax:42.9},minScale:5e5,rotationEnabled:!1};const de={type:"simple",symbol:{type:"simple-fill",color:[0,0,0,0],outline:{width:2,color:[204,85,0]}}},q=new l({url:"https://crgis.cedar-rapids.org/arcgisserver/rest/services/CMO/Near_Me_Map_Layers/FeatureServer/20",outFields:["*"],opacity:1,popupEnabled:!1,renderer:de});c.add(q);const E=new l({url:"https://crgis.cedar-rapids.org/arcgisserver/rest/services/CMO/Near_Me_Map_Layers/FeatureServer/17",outFields:["*"],opacity:0,popupEnabled:!1});c.add(E);const ue=await $arcgis.import("@arcgis/core/layers/GraphicsLayer.js");let M=new ue({graphics:null});c.add(M);const j=new l({url:"https://crgis.cedar-rapids.org/arcgis/rest/services/Maps/NeighborhoodApp/MapServer/0",outFields:["*"],opacity:0,popupEnabled:!1});c.add(j);const G=new l({url:"https://crgis.cedar-rapids.org/arcgisserver/rest/services/CMO/Near_Me_Map_Layers/FeatureServer/19",outFields:["*"],opacity:0,popupEnabled:!1});c.add(G);const U=new l({url:"https://crgis.cedar-rapids.org/arcgisserver/rest/services/CMO/Near_Me_Map_Layers/FeatureServer/5",outFields:["*"],opacity:0,popupEnabled:!1});c.add(U);const Y=new l({url:"https://crgis.cedar-rapids.org/arcgisserver/rest/services/CMO/Near_Me_Map_Layers/FeatureServer/7",outFields:["*"],opacity:0,popupEnabled:!1});c.add(Y);const K=new l({url:"https://crgis.cedar-rapids.org/arcgisserver/rest/services/CMO/Near_Me_Map_Layers/FeatureServer/6",outFields:["*"],opacity:0,popupEnabled:!1});c.add(K);const Q=new l({url:"https://crgis.cedar-rapids.org/arcgisserver/rest/services/CMO/Near_Me_Map_Layers/FeatureServer/9",outFields:["*"],opacity:0,popupEnabled:!1});c.add(Q);const W=new l({url:"https://crgis.cedar-rapids.org/arcgisserver/rest/services/CMO/Near_Me_Map_Layers/FeatureServer/8",outFields:["*"],opacity:0,popupEnabled:!1});c.add(W);const F=new l({url:"https://crgis.cedar-rapids.org/arcgisserver/rest/services/CMO/Near_Me_Map_Layers/FeatureServer/3",outFields:["*"],opacity:0,popupEnabled:!1});c.add(F);const g=new l({url:"https://crgis.cedar-rapids.org/arcgisserver/rest/services/CMO/Near_Me_Map_Layers/FeatureServer/2",outFields:["*"],opacity:0,popupEnabled:!1});c.add(g);const z=new l({url:"https://crgis.cedar-rapids.org/arcgisserver/rest/services/CMO/Near_Me_Map_Layers/FeatureServer/13",outFields:["*"],opacity:0,popupEnabled:!1});c.add(z);const $=new l({url:"https://crgis.cedar-rapids.org/arcgisserver/rest/services/CMO/Near_Me_Map_Layers/FeatureServer/10",outFields:["*"],opacity:0,popupEnabled:!1});c.add($);const V=new l({url:"https://crgis.cedar-rapids.org/arcgisserver/rest/services/CMO/Near_Me_Map_Layers/FeatureServer/15",outFields:["*"],opacity:0,popupEnabled:!1});c.add(V);const J=new l({url:"https://crgis.cedar-rapids.org/arcgisserver/rest/services/CMO/Near_Me_Map_Layers/FeatureServer/14",outFields:["*"],opacity:0,popupEnabled:!1});c.add(J);const X=new l({url:"https://crgis.cedar-rapids.org/arcgis/rest/services/Maps/Public_Works/MapServer/35",outFields:["*"],opacity:0,popupEnabled:!1});c.add(X);const pe=window.location.search,ye=new URLSearchParams(pe),C={};if(ye.forEach((e,t)=>{C[t]=e}),C.xy){console.log("... resolving URL parameter 'XY'");const e=C.xy.split(",")[0],t=C.xy.split(",")[1];var n={type:"point",x:e,y:t,spatialReference:{wkid:4326}};N(n)}else{var n={type:"point",x:-91.6697,y:41.9774,spatialReference:{wkid:4326}};N(n)}let ge={type:"simple-marker",color:"black",size:4,style:"circle"};const me=new l({url:"https://crgis.cedar-rapids.org/arcgisserver/rest/services/CMO/Near_Me_Map_Layers/FeatureServer/18",outFields:["*"],opacity:1,popupEnabled:!0,renderer:{type:"simple",symbol:ge}});c.add(me);var ve={include:[q]};v.on("click",e=>{v.hitTest(e,ve).then(t=>{if(console.log("Processing mapClick..."),t.results.length){const r=t.results[0];n={type:"point",x:r.mapPoint.longitude,y:r.mapPoint.latitude,spatialReference:{wkid:4326}},N(n)}else alert("Sorry, but that location appears to be outside our city!")})});var he=document.getElementById("showmore_btn");he.addEventListener("click",function(e){se()}),console.log("Popup 'listeners'");for(var Z=await document.getElementsByClassName("popup_col_val"),k=0;k<Z.length;k++)Z[k].classList.remove("active"),Z[k].addEventListener("mousedown",function(e){M.removeAll(),ce(e)});var fe=document.getElementById("locate_btn");fe.addEventListener("click",function(e){console.log("locate_btn click");function t(){navigator.geolocation?navigator.geolocation.getCurrentPosition(r,o):alert("Sorry, we encountered an error while accessing your location.")}function r(s){var i=s.coords.longitude,u=s.coords.latitude;n={type:"point",x:i,y:u,spatialReference:{wkid:4326}},console.log("GPS:",n),N(n)}function o(){alert("Sorry, we could not retrieve a GPS location.")}t()});const ae=document.getElementById("search_btn"),_e=document.getElementById("search_modal"),A=document.getElementById("search_text"),ie=document.getElementById("search_address_list");document.getElementById("search_submit").addEventListener("click",async function(e){console.log("User submitted search.");var t=A.value,r={where:`SITEADDRESS = '${t}'`,outFields:["*"],returnGeometry:!0,outSpatialReference:v.spatialReference},o=await E.queryFeatures(r);if(o.features.length>0){var s=o.features[0].geometry.centroid;console.log("addrPoint",s);var i=s.longitude,u=s.latitude;n={type:"point",x:i,y:u,spatialReference:{wkid:4326}},N(n)}else alert(`We were unable to find an exact match for the address: '${t}'`)}),ae.addEventListener("click",async function(e){_e.classList.toggle("display_none"),ae.classList.toggle("search_active");for(var t={where:"OBJECTID > -1",outFields:["*"],returnGeometry:!1},r=await E.queryFeatures(t),o="",s=0;s<100;s++){var i=r.features[s].attributes.SITEADDRESS;o+='<option value="'+i+'">'+i+"</option>"}return ie.innerHTML=o,!0});async function Ee(){console.log("Search Filter...",A.value);for(var e=`SITEADDRESS LIKE '%${A.value}%'`,t={where:e,outFields:["*"],returnGeometry:!1},r=await E.queryFeatures(t),o="",s=0;s<r.features.length;s++){var i=r.features[s].attributes.SITEADDRESS;o+='<option value="'+i+'">'+i+"</option>"}ie.innerHTML=o}A.addEventListener("input",async function(e){function t(o,s){let i;return function(...u){clearTimeout(i),i=setTimeout(()=>o.apply(this,u),s)}}var r=t(Ee,100);r()})});
